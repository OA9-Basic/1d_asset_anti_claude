generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  ADMIN
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  WITHDRAWAL_REQUEST
  CONTRIBUTION
  CONTRIBUTION_REFUND
  PROFIT_DISTRIBUTION
  ASSET_PURCHASE
  STORE_CREDIT_CONVERSION
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  REVERSED
}

enum AssetStatus {
  REQUESTED
  APPROVED
  COLLECTING
  PURCHASED
  AVAILABLE
  PAUSED
  REJECTED
}

enum WebhookType {
  ALCHEMY_NOTIFY
  CUSTOM
}

enum CryptoNetwork {
  ETHEREUM_MAINNET
  POLYGON_MAINNET
  BSC_MAINNET
}

enum CryptoCurrency {
  ETH
  USDT_POLYGON
  USDC_POLYGON
  USDT_BSC
  USDC_BSC
  BNB
  MATIC
}

enum DepositOrderStatus {
  CREATED
  AWAITING_PAYMENT
  CONFIRMING
  COMPLETED
  EXPIRED
  FAILED
}

enum AssetType {
  COURSE
  AI_MODEL
  SAAS
  SOFTWARE
  TEMPLATE
  CODE
  MODEL_3D
  EBOOK
  OTHER
}

enum DeliveryType {
  DOWNLOAD
  STREAM
  EXTERNAL
  HYBRID
}

enum ProfitDistributionTiming {
  IMMEDIATE
  DAILY
  WEEKLY
  MONTHLY
  CUSTOM
}

enum AssetRequestStatus {
  PENDING
  UNDER_REVIEW
  APPROVED
  REJECTED
  VOTING
}

enum VoteType {
  UPVOTE
  DOWNVOTE
}

enum WithdrawalStatus {
  PENDING
  PROCESSING
  COMPLETED
  REJECTED
  CANCELLED
}

enum ContributionStatus {
  ACTIVE
  REFUNDED
  CONVERTED_TO_INVESTMENT
}

model User {
  id                String             @id @default(cuid())
  email             String             @unique
  emailVerified     Boolean            @default(false)
  username          String?            @unique
  passwordHash      String?
  firstName         String?
  lastName          String?
  avatar            String?
  role              UserRole           @default(USER)
  isActive          Boolean            @default(true)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  wallet            Wallet?
  contributions     Contribution[]
  assetPurchases    AssetPurchase[]
  assetRequests     AssetRequest[]
  votes             Vote[]
  withdrawals       WithdrawalRequest[]
  profitShares      ProfitShare[]
  depositOrders     DepositOrder[]

  @@index([role])
  @@index([isActive])
}

model Wallet {
  id                    String             @id @default(cuid())
  userId                String             @unique
  balance               Float              @default(0)
  withdrawableBalance   Float              @default(0)
  storeCredit           Float              @default(0)
  totalDeposited        Float              @default(0)
  totalWithdrawn        Float              @default(0)
  totalConvertedToCredit Float             @default(0)
  totalContributed      Float              @default(0)
  totalProfitReceived   Float              @default(0)
  lockedBalance         Float              @default(0)
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt

  user                  User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions          Transaction[]
  withdrawalRequests    WithdrawalRequest[]
}

model Transaction {
  id                String             @id @default(cuid())
  walletId          String
  userId            String?
  type              TransactionType
  status            TransactionStatus  @default(PENDING)
  amount            Float
  currency          String             @default("USD")
  balanceBefore     Float
  balanceAfter      Float
  referenceId       String?
  referenceType     String?
  description       String?
  metadata          Json?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  // Crypto verification fields
  txHash            String?            @unique
  confirmations     Int                @default(0)
  verified          Boolean            @default(false)
  verifiedAt        DateTime?
  verifiedFrom      String?            // e.g., "ALCHEMY", "ETHERSCAN"
  blockNumber       BigInt?
  blockTimestamp    DateTime?
  network           CryptoNetwork?

  // Deposit order fields
  depositOrderId    String?            @unique

  wallet            Wallet             @relation(fields: [walletId], references: [id], onDelete: Cascade)
  depositOrder      DepositOrder?      @relation(fields: [depositOrderId], references: [id], onDelete: Cascade)

  @@index([walletId])
  @@index([userId])
  @@index([type])
  @@index([status])
  @@index([referenceId, referenceType])
  @@index([txHash])
  @@index([depositOrderId])
  @@index([verified, network])
  @@index([createdAt])
}

model Asset {
  id                    String                    @id @default(cuid())
  title                 String
  description           String
  slug                  String                    @unique
  type                  AssetType
  deliveryType          DeliveryType              @default(DOWNLOAD)
  targetPrice           Float
  platformFee           Float                     @default(0.15)
  platformFeeAfterExcess Float                   @default(0.15)
  currentCollected      Float                     @default(0)
  status                AssetStatus               @default(REQUESTED)
  totalPurchases        Int                       @default(0)
  totalRevenue          Float                     @default(0)
  totalProfitDistributed Float                    @default(0)
  deliveryUrl           String?
  deliveryKey           String?
  streamUrl             String?
  externalAccessUrl     String?
  externalCredentials   Json?
  thumbnail             String?
  sourceUrl             String?
  metadata              Json?
  featured              Boolean                   @default(false)

  // Profit Distribution Settings
  profitDistributionTiming ProfitDistributionTiming @default(IMMEDIATE)
  customDistributionInterval Int?                   // Custom interval in hours
  lastDistributionAt    DateTime?

  approvedAt            DateTime?
  purchasedAt           DateTime?
  availableAt           DateTime?
  votingStartsAt        DateTime?
  votingEndsAt          DateTime?
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt

  contributions         Contribution[]
  assetPurchases        AssetPurchase[]
  profitShares          ProfitShare[]
  profitDistributions   ProfitDistribution[]
  request               AssetRequest?

  @@index([status])
  @@index([type])
  @@index([slug])
  @@index([createdAt])
  @@index([featured])
  @@index([deliveryType])
  @@index([profitDistributionTiming])
}

model AssetRequest {
  id                String              @id @default(cuid())
  userId            String
  assetId           String?             @unique
  title             String
  description       String
  type              AssetType
  deliveryType      DeliveryType        @default(DOWNLOAD)
  estimatedPrice    Float
  sourceUrl         String
  thumbnail         String?
  metadata          Json?
  status            AssetRequestStatus  @default(PENDING)
  adminNotes        String?
  rejectionReason   String?
  votedAt           DateTime?
  approvedAt        DateTime?
  rejectedAt        DateTime?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  asset             Asset?              @relation(fields: [assetId], references: [id], onDelete: Cascade)
  votes             Vote[]

  @@index([status])
  @@index([userId])
  @@index([createdAt])
}

model Vote {
  id                String       @id @default(cuid())
  userId            String
  assetRequestId    String
  voteType          VoteType
  createdAt         DateTime     @default(now())

  user              User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  assetRequest      AssetRequest @relation(fields: [assetRequestId], references: [id], onDelete: Cascade)

  @@unique([userId, assetRequestId])
  @@index([assetRequestId])
  @@index([voteType])
}

model Contribution {
  id                String             @id @default(cuid())
  userId            String
  assetId           String
  amount            Float
  excessAmount      Float              @default(0)
  profitShareRatio  Float              @default(0)
  totalProfitReceived Float            @default(0)
  status            ContributionStatus @default(ACTIVE)
  isInvestment      Boolean            @default(false)
  refundedAt        DateTime?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  asset             Asset              @relation(fields: [assetId], references: [id], onDelete: Cascade)
  profitShares      ProfitShare[]

  @@index([assetId])
  @@index([userId])
  @@index([status])
  @@index([isInvestment])
}

model ProfitShare {
  id                String       @id @default(cuid())
  contributionId    String
  assetId           String
  userId            String
  amount            Float
  shareRatio        Float
  dailyRevenue      Float
  distributedAt     DateTime     @default(now())
  createdAt         DateTime     @default(now())

  contribution      Contribution @relation(fields: [contributionId], references: [id], onDelete: Cascade)
  asset             Asset        @relation(fields: [assetId], references: [id], onDelete: Cascade)
  user              User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([contributionId])
  @@index([assetId])
  @@index([userId])
  @@index([distributedAt])
}

model AssetPurchase {
  id                String   @id @default(cuid())
  userId            String
  assetId           String
  purchaseAmount    Float    @default(1)
  deliveryAccessKey String?
  deliveryExpiry    DateTime?
  accessCount       Int      @default(0)
  lastAccessedAt    DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  asset             Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([assetId])
  @@index([userId])
  @@index([createdAt])
}

model WithdrawalRequest {
  id                String           @id @default(cuid())
  walletId          String
  userId            String
  amount            Float
  cryptoCurrency    String
  walletAddress     String
  status            WithdrawalStatus @default(PENDING)
  adminNotes        String?
  rejectionReason   String?
  processedAt       DateTime?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  wallet            Wallet           @relation(fields: [walletId], references: [id], onDelete: Cascade)
  user              User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([walletId])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model ProfitDistribution {
  id                String   @id @default(cuid())
  assetId           String
  totalRevenue      Float
  platformProfit    Float
  contributorProfit Float
  distributedShares Int      @default(0)
  distributionDate  DateTime @default(now())
  createdAt         DateTime @default(now())

  asset             Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([assetId])
  @@index([distributionDate])
}

// ============================================================================
// CRYPTO PAYMENT SYSTEM MODELS
// ============================================================================

/// Deposit Orders - User-initiated deposit requests with price locking
model DepositOrder {
  id                String             @id @default(cuid())
  userId            String

  // Order Details
  usdAmount         Float              // Amount in USD user wants to deposit
  cryptoAmount      Float              // Exact crypto amount needed
  cryptoCurrency    CryptoCurrency
  network           CryptoNetwork

  // Price Locking
  priceAtCreation   Float              // Crypto price in USD at order creation
  priceExpiresAt    DateTime           // When price lock expires (15 mins)

  // Address Generation
  depositAddress    String             @unique // HD-derived address
  derivationPath    String             // BIP44 path (e.g., "m/44'/60'/0'/0/5")
  privateKeyEncrypted String?         // AES-256 encrypted private key

  // Order Status
  status            DepositOrderStatus @default(CREATED)
  expiresAt         DateTime           // Order expiry (15 mins from creation)

  // Transaction Details
  txHash            String?            @unique
  confirmations     Int                @default(0)
  requiredConfirmations Int            @default(12) // Network-specific

  // Payment Verification
  receivedAmount    Float?             // Actual amount received
  overpaid          Boolean            @default(false)
  underpaid         Boolean            @default(false)
  slippageTolerance Float              @default(0.01) // 1%

  // Timestamps
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  confirmedAt       DateTime?
  completedAt       DateTime?

  // Relations
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions      Transaction[]

  @@index([userId])
  @@index([status])
  @@index([depositAddress])
  @@index([txHash])
  @@index([expiresAt])
  @@index([createdAt])
}

/// HD Wallet Configuration - Master keys (NEVER store xpriv here!)
model HDWalletConfig {
  id                String             @id @default(cuid())
  network           CryptoNetwork     @unique // One config per network

  // Public Keys Only (Safe to store on hot server)
  xpub              String             // Extended public key (BIP32)
  derivationPath    String             // Base derivation path (e.g., "m/44'/60'/0'/0")

  // Address Index Tracking
  lastUsedIndex     Int                @default(0)
  nextUnusedIndex   Int                @default(0)

  // Cold Storage Configuration
  coldWalletAddress String            // Main cold wallet address
  sweepThreshold   Float              // Auto-forward when balance exceeds this (in native currency)
  sweepMinAmount   Float              @default(0.001) // Minimum amount to sweep

  // Network Configuration
  chainId           Int
  rpcUrl            String
  explorerUrl       String

  // Alchemy Configuration
  alchemyApiKey     String?            // For webhooks and enhanced APIs
  webhookId         String?            // Alchemy webhook ID
  webhookSignature  String?            // For webhook verification

  // Timestamps
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  // Relations
  walletAddresses   WalletAddress[]

  @@index([network])
}

/// Generated Wallet Addresses - Track all derived addresses
model WalletAddress {
  id                String             @id @default(cuid())
  hdWalletConfigId  String

  // Address Details
  address           String
  derivationPath    String             // Full path (e.g., "m/44'/60'/0'/0/5")
  derivationIndex   Int                // The index used

  // Usage Tracking
  isUsed            Boolean            @default(false)
  firstUsedAt       DateTime?
  lastUsedAt        DateTime?
  totalReceived     Float              @default(0) // Total amount received

  // Status
  isActive          Boolean            @default(true)
  isSwept           Boolean            @default(false) // Whether funds were forwarded to cold storage
  sweptAt           DateTime?

  // Private Key Storage (ENCRYPTED with AES-256)
  privateKeyEncrypted String?

  // Timestamps
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  // Relations
  hdWalletConfig    HDWalletConfig     @relation(fields: [hdWalletConfigId], references: [id], onDelete: Cascade)

  @@unique([hdWalletConfigId, derivationIndex])
  @@index([address])
  @@index([isUsed])
  @@index([isSwept])
}

/// Webhook Logs - Track all incoming webhooks
model WebhookLog {
  id                String             @id @default(cuid())
  type              WebhookType

  // Webhook Details
  webhookId         String?            // e.g., Alchemy webhook ID
  source            String             // e.g., "alchemy-notify"
  eventId           String?            // Unique event ID for deduplication

  // Payload
  payload           String             // JSON payload
  signature         String?            // Webhook signature for verification

  // Processing
  processed         Boolean            @default(false)
  processingError   String?
  processingTime    Int?               // Processing time in ms

  // Related Data
  txHash            String?
  depositOrderId    String?

  // Timestamps
  receivedAt        DateTime           @default(now())
  processedAt       DateTime?

  @@index([source, eventId])
  @@index([txHash])
  @@index([depositOrderId])
  @@index([processed])
}

/// Network Configuration - Store chain-specific settings
model NetworkConfig {
  id                String             @id @default(cuid())
  network           CryptoNetwork     @unique

  // Chain Details
  chainId           Int
  name              String
  symbol            String             // e.g., "ETH", "BNB", "MATIC"

  // RPC Endpoints
  rpcUrl            String
  fallbackRpcUrls   String             // JSON array of fallback URLs

  // Block Explorer
  explorerUrl       String
  apiEndpoint       String?            // For Etherscan/BscScan APIs

  // Gas Settings
  gasPriceMultiplier Float             @default(1.1) // Add 10% to estimated gas
  maxGasPrice       Float?             // Maximum gas price willing to pay

  // Confirmation Requirements
  requiredConfirmations Int            @default(12)
  targetConfirmations   Int            @default(12)

  // Token Contracts (for USDT, USDC, etc.)
  nativeCurrency   String             @default("ETH")
  tokenContracts   String?            // JSON map: {"USDT": "0x...", "USDC": "0x..."}

  // Status
  isActive          Boolean            @default(true)
  maintenanceMode  Boolean            @default(false)

  // Timestamps
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  @@index([isActive])
}

/// Security Audit Log - Track all sensitive operations
model AuditLog {
  id                String             @id @default(cuid())
  userId            String?            // Null for system operations

  // Event Details
  action            String             // e.g., "DEPOSIT_CREATED", "WEBHOOK_RECEIVED"
  category          String             // e.g., "CRYPTO", "AUTH", "ADMIN"
  severity          String             @default("INFO") // INFO, WARNING, ERROR, CRITICAL

  // Data
  details           String             // JSON payload
  ipAddress         String?
  userAgent         String?

  // Related Entities
  relatedUserId     String?
  relatedOrderId    String?
  relatedTxHash     String?

  // Result
  success           Boolean            @default(true)
  errorCode         String?
  errorMessage      String?

  // Timestamp
  createdAt         DateTime           @default(now())

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@index([severity])
}
