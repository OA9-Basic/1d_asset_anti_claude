generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  ADMIN
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  WITHDRAWAL_REQUEST
  CONTRIBUTION
  CONTRIBUTION_REFUND
  PROFIT_DISTRIBUTION
  ASSET_PURCHASE
  STORE_CREDIT_CONVERSION
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  REVERSED
}

enum AssetStatus {
  REQUESTED
  APPROVED
  COLLECTING
  PURCHASED
  AVAILABLE
  PAUSED
  REJECTED
}

enum AssetType {
  COURSE
  AI_MODEL
  SAAS
  SOFTWARE
  TEMPLATE
  CODE
  MODEL_3D
  EBOOK
  OTHER
}

enum DeliveryType {
  DOWNLOAD
  STREAM
  EXTERNAL
  HYBRID
}

enum ProfitDistributionTiming {
  IMMEDIATE
  DAILY
  WEEKLY
  MONTHLY
  CUSTOM
}

enum AssetRequestStatus {
  PENDING
  UNDER_REVIEW
  APPROVED
  REJECTED
  VOTING
}

enum VoteType {
  UPVOTE
  DOWNVOTE
}

enum WithdrawalStatus {
  PENDING
  PROCESSING
  COMPLETED
  REJECTED
  CANCELLED
}

enum ContributionStatus {
  ACTIVE
  REFUNDED
  CONVERTED_TO_INVESTMENT
}

model User {
  id                String             @id @default(cuid())
  email             String             @unique
  emailVerified     Boolean            @default(false)
  username          String?            @unique
  passwordHash      String?
  firstName         String?
  lastName          String?
  avatar            String?
  role              UserRole           @default(USER)
  isActive          Boolean            @default(true)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  wallet            Wallet?
  contributions     Contribution[]
  assetPurchases    AssetPurchase[]
  assetRequests     AssetRequest[]
  votes             Vote[]
  withdrawals       WithdrawalRequest[]
  profitShares      ProfitShare[]

  @@index([role])
  @@index([isActive])
}

model Wallet {
  id                    String             @id @default(cuid())
  userId                String             @unique
  balance               Float              @default(0)
  withdrawableBalance   Float              @default(0)
  storeCredit           Float              @default(0)
  totalDeposited        Float              @default(0)
  totalWithdrawn        Float              @default(0)
  totalConvertedToCredit Float             @default(0)
  totalContributed      Float              @default(0)
  totalProfitReceived   Float              @default(0)
  lockedBalance         Float              @default(0)
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt

  user                  User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions          Transaction[]
  withdrawalRequests    WithdrawalRequest[]
}

model Transaction {
  id                String             @id @default(cuid())
  walletId          String
  type              TransactionType
  status            TransactionStatus  @default(PENDING)
  amount            Float
  balanceBefore     Float
  balanceAfter      Float
  referenceId       String?
  referenceType     String?
  description       String?
  metadata          Json?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  wallet            Wallet             @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@index([walletId])
  @@index([type])
  @@index([status])
  @@index([referenceId, referenceType])
  @@index([createdAt])
}

model Asset {
  id                    String                    @id @default(cuid())
  title                 String
  description           String
  slug                  String                    @unique
  type                  AssetType
  deliveryType          DeliveryType              @default(DOWNLOAD)
  targetPrice           Float
  platformFee           Float                     @default(0.15)
  platformFeeAfterExcess Float                   @default(0.15)
  currentCollected      Float                     @default(0)
  status                AssetStatus               @default(REQUESTED)
  totalPurchases        Int                       @default(0)
  totalRevenue          Float                     @default(0)
  totalProfitDistributed Float                    @default(0)
  deliveryUrl           String?
  deliveryKey           String?
  streamUrl             String?
  externalAccessUrl     String?
  externalCredentials   Json?
  thumbnail             String?
  sourceUrl             String?
  metadata              Json?
  featured              Boolean                   @default(false)

  // Profit Distribution Settings
  profitDistributionTiming ProfitDistributionTiming @default(IMMEDIATE)
  customDistributionInterval Int?                   // Custom interval in hours
  lastDistributionAt    DateTime?

  approvedAt            DateTime?
  purchasedAt           DateTime?
  availableAt           DateTime?
  votingStartsAt        DateTime?
  votingEndsAt          DateTime?
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt

  contributions         Contribution[]
  assetPurchases        AssetPurchase[]
  profitShares          ProfitShare[]
  profitDistributions   ProfitDistribution[]
  request               AssetRequest?

  @@index([status])
  @@index([type])
  @@index([slug])
  @@index([createdAt])
  @@index([featured])
  @@index([deliveryType])
  @@index([profitDistributionTiming])
}

model AssetRequest {
  id                String              @id @default(cuid())
  userId            String
  assetId           String?             @unique
  title             String
  description       String
  type              AssetType
  deliveryType      DeliveryType        @default(DOWNLOAD)
  estimatedPrice    Float
  sourceUrl         String
  thumbnail         String?
  metadata          Json?
  status            AssetRequestStatus  @default(PENDING)
  adminNotes        String?
  rejectionReason   String?
  votedAt           DateTime?
  approvedAt        DateTime?
  rejectedAt        DateTime?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  asset             Asset?              @relation(fields: [assetId], references: [id], onDelete: Cascade)
  votes             Vote[]

  @@index([status])
  @@index([userId])
  @@index([createdAt])
}

model Vote {
  id                String       @id @default(cuid())
  userId            String
  assetRequestId    String
  voteType          VoteType
  createdAt         DateTime     @default(now())

  user              User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  assetRequest      AssetRequest @relation(fields: [assetRequestId], references: [id], onDelete: Cascade)

  @@unique([userId, assetRequestId])
  @@index([assetRequestId])
  @@index([voteType])
}

model Contribution {
  id                String             @id @default(cuid())
  userId            String
  assetId           String
  amount            Float
  excessAmount      Float              @default(0)
  profitShareRatio  Float              @default(0)
  totalProfitReceived Float            @default(0)
  status            ContributionStatus @default(ACTIVE)
  isInvestment      Boolean            @default(false)
  refundedAt        DateTime?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  asset             Asset              @relation(fields: [assetId], references: [id], onDelete: Cascade)
  profitShares      ProfitShare[]

  @@index([assetId])
  @@index([userId])
  @@index([status])
  @@index([isInvestment])
}

model ProfitShare {
  id                String       @id @default(cuid())
  contributionId    String
  assetId           String
  userId            String
  amount            Float
  shareRatio        Float
  dailyRevenue      Float
  distributedAt     DateTime     @default(now())
  createdAt         DateTime     @default(now())

  contribution      Contribution @relation(fields: [contributionId], references: [id], onDelete: Cascade)
  asset             Asset        @relation(fields: [assetId], references: [id], onDelete: Cascade)
  user              User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([contributionId])
  @@index([assetId])
  @@index([userId])
  @@index([distributedAt])
}

model AssetPurchase {
  id                String   @id @default(cuid())
  userId            String
  assetId           String
  purchaseAmount    Float    @default(1)
  deliveryAccessKey String?
  deliveryExpiry    DateTime?
  accessCount       Int      @default(0)
  lastAccessedAt    DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  asset             Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([assetId])
  @@index([userId])
  @@index([createdAt])
}

model WithdrawalRequest {
  id                String           @id @default(cuid())
  walletId          String
  userId            String
  amount            Float
  cryptoCurrency    String
  walletAddress     String
  status            WithdrawalStatus @default(PENDING)
  adminNotes        String?
  rejectionReason   String?
  processedAt       DateTime?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  wallet            Wallet           @relation(fields: [walletId], references: [id], onDelete: Cascade)
  user              User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([walletId])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model ProfitDistribution {
  id                String   @id @default(cuid())
  assetId           String
  totalRevenue      Float
  platformProfit    Float
  contributorProfit Float
  distributedShares Int      @default(0)
  distributionDate  DateTime @default(now())
  createdAt         DateTime @default(now())

  asset             Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([assetId])
  @@index([distributionDate])
}
