# ุชุญููู ุดุงูู ููุธุงู ุงูุฏูุน ุจุงูุนููุงุช ุงููุดูุฑุฉ

## โ ุงูููููุงุช ุงูููููููุฐุฉ ูุงูุนูููุฉ

### 1. Low-Fee Networks Priority โ
**ุงูุญุงูุฉ: ููููููุฐ ุจุงููุงูู**

ุงููุธุงู ูุฏุนู ุงูุดุจูุงุช ุงูุชุงููุฉ ูุน ุงูุฃููููุฉ ููุฑุณูู ุงูููุฎูุถุฉ:

#### ุดุจูุฉ BSC (Binance Smart Chain) - ุงูุฃูู ุฑุณููุงู
- **Chain ID:** 56
- **ุงูุนููุงุช ุงููุฏุนููุฉ:**
  - BNB (ุงูุนููุฉ ุงูุฃุตููุฉ)
  - USDT (BEP20) - ุงูุนููุงู: `0x55d398326f99059fF775485246999027B3197955`
  - USDC (BEP20) - ุงูุนููุงู: `0x8AC76a51cc950d9822D68b83fE1Ad97B32Cd580d`
- **RPC:** Alchemy (`https://bnb-mainnet.g.alchemy.com/v2/${ALCHEMY_API_KEY}`)
- **ุงูุชุฃููุฏุงุช ุงููุทููุจุฉ:** 10
- **ุงูุฑุณูู:** ููุฎูุถุฉ ุฌุฏุงู (~$0.10-$0.50 ูููุนุงููุฉ)

#### ุดุจูุฉ Polygon (MATIC) - ุฑุณูู ููุฎูุถุฉ
- **Chain ID:** 137
- **ุงูุนููุงุช ุงููุฏุนููุฉ:**
  - MATIC (ุงูุนููุฉ ุงูุฃุตููุฉ)
  - USDT (Polygon) - ุงูุนููุงู: `0xc2132d05d31c914a87c6611c10748aeb04b58e8f`
  - USDC (Polygon) - ุงูุนููุงู: `0x3c499c542cEF5E3811e1192ce70d8cC03d5c3359`
- **RPC:** Alchemy (`https://polygon-mainnet.g.alchemy.com/v2/${ALCHEMY_API_KEY}`)
- **ุงูุชุฃููุฏุงุช ุงููุทููุจุฉ:** 30 (Polygon ุฃุณุฑุน ูู ุงูุฅููุงุก)
- **ุงูุฑุณูู:** ููุฎูุถุฉ (~$0.01-$0.10 ูููุนุงููุฉ)

#### ุดุจูุฉ Ethereum - ุฑุณูู ุฃุนูู
- **Chain ID:** 1
- **ุงูุนููุงุช:** ETH, USDT, USDC
- **ุงูุชุฃููุฏุงุช ุงููุทููุจุฉ:** 12
- **ุงูุฑุณูู:** ุนุงููุฉ (~$5-$50 ูููุนุงููุฉ)
- **ููุงุญุธุฉ:** ุบูุฑ ููุตู ุจูุง ูููุจุงูุบ ุงูุตุบูุฑุฉ (<$100)

### 2. Tech Stack & APIs โ
**ุงูุญุงูุฉ: ููููููุฐ ุจุงููุงูู**

#### Alchemy Integration โ
**ุงููููุน:** `src/lib/blockchain/alchemy.ts`

**ุงููุธุงุฆู ุงูููููููุฐุฉ:**
1. **Webhooks (Alchemy Notify):**
   - ูุนุงูุฌุฉ ุฅุดุนุงุฑุงุช ุงููุนุงููุงุช ุงูููุฑูุฉ
   - ุงูุชุญูู ูู ุงูุชูููุน (HMAC-SHA256)
   - ูุนุงูุฌุฉ ูุดุงุท ุงูุนูุงููู (ADDRESS_ACTIVITY)
   - ุชุณุฌูู ุฌููุน ุงูู webhooks ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

2. **JSON-RPC Calls:**
   - `eth_getBlockByNumber` - ููุญุตูู ุนูู ูุนูููุงุช ุงููุชูุฉ
   - `eth_getTransactionReceipt` - ููุชุฃูุฏ ูู ุงููุนุงููุฉ
   - `eth_getTransaction` - ููุญุตูู ุนูู ุชูุงุตูู ุงููุนุงููุฉ
   - ุงูุชุญูู ูู ุนุฏุฏ ุงูุชุฃููุฏุงุช

3. **Verification Service:**
   - ุงูุชุญูู ูู ูุนุงููุงุช ุงูุนููุฉ ุงูุฃุตููุฉ (ETH, BNB, MATIC)
   - ุงูุชุญูู ูู ูุนุงููุงุช ERC-20 (USDT, USDC)
   - ุงูุชุญูู ูู `chainId`, `to` address, `value`
   - ููุน ูุฌูุงุช Replay ุจุงูุชุญูู ูู ุชูุฑุฏ `txHash`

#### CoinLore API โ (ุฌุฏูุฏ)
**ุงููููุน:** `src/lib/blockchain/coinlore.ts`

**ุงููุธุงุฆู:**
1. **Real-time Price Conversion:**
   ```typescript
   // ุงูุญุตูู ุนูู ุณุนุฑ ุงูุนููุฉ ุจุงูุฏููุงุฑ
   getCryptoPrice(currency) // ููุฑุฌุน { usd, usd_24h_change, market_cap }

   // ุชุญููู ุงูุฏููุงุฑ ุฅูู ุนููุฉ ูุดูุฑุฉ ูุน ูุงูุด ุฃูุงู
   usdToCrypto(usdAmount, 'USDT_BSC', {
     safetyMargin: 0.01, // 1% ูุงูุด ุฃูุงู
     quoteExpiryMinutes: 15 // ุงูุณุนุฑ ูููู ููุฏุฉ 15 ุฏูููุฉ
   })
   ```

2. **ุงูููุฒุงุช:**
   - API ูุฌุงูู ุจุฏูู ุญุฏูุฏ ูุนุฏูุฉ
   - ูุง ูุญุชุงุฌ API Key
   - ุฏุนู ูุฌููุน ุงูุนููุงุช ุงููุทููุจุฉ
   - ุชุฎุฒูู ูุคูุช ููุฃุณุนุงุฑ (1 ุฏูููุฉ)
   - ุญุณุงุจ ุชููุงุฆู ููุนููุฉ ุงูููุตู ุจูุง ุจูุงุกู ุนูู ุงููุจูุบ

### 3. Functional Logic (Happy Path) โ
**ุงูุญุงูุฉ: ููููููุฐ ุจุงููุงูู**

#### ุฎุทูุฉ 1: ุงููุณุชุฎุฏู ููุฏุฎู ุงููุจูุบ ุจุงูุฏููุงุฑ
**ุงููููุน:** Frontend (`src/components/wallet/deposit-flow.tsx`)
- ุงููุณุชุฎุฏู ููุฏุฎู ูุจูุบ USD (ูุซูุงู $10)
- ุงูุชุญูู ูู ุตุญุฉ ุงููุฏุฎูุงุช (Zod validation)
- ุงูุญุฏ ุงูุฃูุตู: $10,000 (ููุญูุงูุฉ ูู ุงูุงุญุชูุงู)

#### ุฎุทูุฉ 2: ุฌูุจ ุงูุณุนุฑ ุงููุจุงุดุฑ ูู CoinLore
**ุงูููุฏ:**
```typescript
const priceQuote = await usdToCrypto(10, 'USDT_BSC');
// ููุฑุฌุน:
// {
//   cryptoAmount: 10.1, // ูุน 1% ูุงูุด ุฃูุงู
//   usdPrice: 1,
//   exchangeRate: 1,
//   currency: 'USDT_BSC',
//   network: 'BSC',
//   expiresAt: Date.now() + 15*60*1000 // 15 ุฏูููุฉ
// }
```

#### ุฎุทูุฉ 3: ุชูููุฏ ุนููุงู ุฅูุฏุงุน ูุฑูุฏ (HD Wallet)
**ุงููููุน:** `src/lib/blockchain/hd-wallet.ts`

**ุงูููุฏ:**
```typescript
// ุงุณุชุฎุฏุงู HD Wallet (BIP44) ูุชูููุฏ ุนููุงู ูุฑูุฏ
const wallet = await deriveWalletWithPrivateKey(
  HD_WALLET_MNEMONIC,
  derivationIndex, // ูุฑูุฏ ููู ุทูุจ
  'BSC',
  ENCRYPTION_KEY
);

// ุชุฎุฒูู ุงูููุชุงุญ ุงูุฎุงุต ูุดูุฑ (AES-256)
// ุงูุนููุงู: 0xabc...123
```

#### ุฎุทูุฉ 4: ุนุฑุถ ุงููุงุฌูุฉ ูููุณุชุฎุฏู
**ุงููููู:** `DepositFlow`

**ุงูููุนุฑููุถ:**
- โ ุงููุจูุบ ุงููุทููุจ (ูุซูุงู: 10.1 USDT)
- โ QR Code ููุนููุงู
- โ ุงูุนููุงู (ูุน ุฒุฑ ุงููุณุฎ)
- โ ูุคูุช (15 ุฏูููุฉ)
- โ ุญุงูุฉ ุงูุทูุจ (Polling ูู 5 ุซูุงูู)
- โ ุดุฑูุท ุชูุฏู ุงูุชุฃููุฏุงุช

#### ุฎุทูุฉ 5: ุงูุงุณุชูุงุน ุนุจุฑ Alchemy Webhook
**ุงููููุน:** `src/app/api/webhooks/alchemy/route.ts`

**ุงูุชุณูุณู:**
1. Alchemy ููุฑุณู webhook ุนูุฏ ุงุณุชูุงู ุงููุนุงููุฉ
2. ุงูุชุญูู ูู ุงูุชูููุน (HMAC-SHA256)
3. ุงูุจุญุซ ุนู ุทูุจ ุงูุฅูุฏุงุน ุจุงูุนููุงู
4. ุงูุชุญูู ูู ุงููุนุงููุฉ ุนูู ุงูู blockchain
5. ุชุญุฏูุซ ุงูุญุงูุฉ โ CONFIRMING
6. ุงูุชุธุงุฑ ุงูุชุฃููุฏุงุช ุงููุทููุจุฉ (BSC: 10, Polygon: 30)
7. ุชุญุฏูุซ ุงูุญุงูุฉ โ COMPLETED
8. **ุชููุงุฆูุงู:** ุชุญููู ุงูุฃููุงู ุฅูู Cold Storage

### 4. Critical Security Architecture โ
**ุงูุญุงูุฉ: ููููููุฐ ุจุงููุงูู (Paranoid Mode)**

#### HD Wallets (BIP44) โ
**ุงููููุน:** `src/lib/blockchain/hd-wallet.ts`

**ุงูุชุทุจูู:**
1. โ ุชูููุฏ ุนููุงู ูุฑูุฏ ููู ุทูุจ ุฅูุฏุงุน
2. โ ุงุณุชุฎุฏุงู BIP44 Path:
   - Ethereum/Polygon/BSC: `m/44'/60'/0'/0/{index}`
3. โ ุฏุนู ุงุณุชุฎุฑุงุฌ xpub (ููุชูููุฏ ุจุฏูู ููุชุงุญ ุฎุงุต)
4. โ ุฏุนู ุงูุชูููุฏ ูู mnemonic (ูู cold storage ููุท)

#### Private Keys Encryption โ
**ุงููููุน:** `src/lib/encryption.ts`

**ุงูุชุทุจูู:**
1. โ ุชุดููุฑ AES-256 ูุฌููุน ุงูููุงุชูุญ ุงูุฎุงุตุฉ
2. โ ุงุณุชุฎุฏุงู `ENCRYPTION_KEY` ูู ุงูุจูุฆุฉ
3. โ ุชุฎุฒูู ุงูููุงุชูุญ ุงููุดูุฑุฉ ููุท ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
4. โ ูู ุงูุชุดููุฑ ุนูุฏ ุงูุญุงุฌุฉ ููุท (ููุณุญุจ)

#### Auto-Forwarding (Cold Storage) โ
**ุงููููุน:** `src/lib/blockchain/sweep.ts`

**ุงูุชุทุจูู:**
1. โ ุงูุชุญูู ุงูุชููุงุฆู ูู ุฑุตูุฏ ุนูุงููู ุงูุฅูุฏุงุน
2. โ ุงูุชุญููู ุนูุฏ ุงููุตูู ููุญุฏ:
   - ETH: 0.01 ETH
   - BNB: 0.01 BNB
   - MATIC: 1 MATIC
   - USDT/USDC: 10 units
3. โ ุงูุชุญููู ุฅูู Cold Wallet:
   - `COLD_WALLET_ETH`
   - `COLD_WALLET_BSC`
   - `COLD_WALLET_POLYGON`
4. โ ุฏุนู ุงูุชุญููู ุงูุชููุงุฆู ููู tokens (ERC-20)
5. โ ุญุณุงุจ ุงูุบุงุฒ ุชููุงุฆูุงู ูุน 20% ูุงูุด ุฃูุงู

#### Replay Attack Prevention โ
**ุงููููุน:** `src/lib/blockchain/alchemy.ts` + `src/app/api/webhooks/alchemy/route.ts`

**ุงูุชุทุจูู:**
1. โ ุงูุชุญูู ูู ุชูุฑุฏ `txHash` (ูุง ูููู ูุนุงูุฌุฉ ููุณ Tx ูุฑุชูู)
2. โ ุงูุชุญูู ูู `chainId`
3. โ ุงูุชุญูู ูู `to` address (ูุทุงุจู ุนููุงู ุงูุฅูุฏุงุน)
4. โ ุงูุชุญูู ูู `value` (ูุทุงุจู ุงููุจูุบ ุงููุชููุน ูุน 1% ุชุณุงูุญ)
5. โ ุงูุชุญูู ูู ุนุฏุฏ ุงูุชุฃููุฏุงุช ุงููุทููุจุฉ

## ๐ ูุงุฆูุฉ ุงูููุฒุงุช ุงูููููููุฐุฉ

### โ Backend APIs

| Endpoint | ุงููุธููุฉ | ุงูุญุงูุฉ |
|----------|---------|--------|
| `POST /api/wallet/deposit-order` | ุฅูุดุงุก ุทูุจ ุฅูุฏุงุน ุฌุฏูุฏ | โ |
| `GET /api/wallet/deposit-order/{id}/status` | ุงูุชุญูู ูู ุญุงูุฉ ุงูุฅูุฏุงุน | โ |
| `POST /api/webhooks/alchemy` | ุงุณุชูุงู ุฅุดุนุงุฑุงุช Alchemy | โ |
| `POST /api/wallet/withdraw` | ุทูุจ ุณุญุจ ุงูุนููุงุช | โ |
| `PATCH /api/admin/withdrawals/{id}` | ููุงููุฉ/ุฑูุถ ุงูุณุญุจ | โ |

### โ Frontend Components

| ุงููููู | ุงููุธููุฉ | ุงูุญุงูุฉ |
|---------|---------|--------|
| `DepositFlow` | ุนุฑุถ ุญุงูุฉ ุงูุฅูุฏุงุนุ QR Codeุ ุงููุคูุช | โ |
| `CreateDepositOrder` | ุฅูุดุงุก ุทูุจ ุฅูุฏุงุน ุฌุฏูุฏ | โ |

### โ Security Features

| ุงูููุฒุฉ | ุงูุชุทุจูู | ุงูุญุงูุฉ |
|---------|---------|--------|
| HD Wallet (BIP44) | ุชูููุฏ ุนูุงููู ูุฑูุฏุฉ | โ |
| AES-256 Encryption | ุชุดููุฑ ุงูููุงุชูุญ ุงูุฎุงุตุฉ | โ |
| Cold Storage Sweep | ุชุญููู ุชููุงุฆู ููุชุฎุฒูู ุงูุจุงุฑุฏ | โ |
| Rate Limiting | ุงูุญุฏ ูู ุงูุทูุจุงุช ุงููุชูุฑุฑุฉ | โ |
| Webhook Signature Verification | HMAC-SHA256 | โ |
| TxHash Uniqueness | ููุน ูุฌูุงุช Replay | โ |
| Chain ID Verification | ุงูุชุญูู ูู ุงูุดุจูุฉ ุงูุตุญูุญุฉ | โ |
| Zod Validation | ุงูุชุญูู ูู ุตุญุฉ ุงููุฏุฎูุงุช | โ |

## ๐ง ูุชุบูุฑุงุช ุงูุจูุฆุฉ ุงููุทููุจุฉ

ุฃุถู ูุฐู ุฅูู `.env`:

```bash
# ============================================================================
# COINLORE API (ูุฌุงููุ ูุง ูุญุชุงุฌ API Key)
# ============================================================================
# ููุงุญุธุฉ: CoinLore API ูุฌุงูู ุชูุงูุงู ุจุฏูู ุญุฏูุฏ ูุนุฏูุฉ

# ============================================================================
# HD WALLET (COLD STORAGE)
# ============================================================================
# WARNING: ูุฐู ุงูููู ูุฌุจ ุชูููุฏูุง ูุฑุฉ ูุงุญุฏุฉ ูู cold storage
# NEVER use test values in production!

HD_WALLET_MNEMONIC="your twelve or twenty four word mnemonic here"
ENCRYPTION_KEY="your-64-character-hex-encryption-key-here-00000000000000000000000"

# ============================================================================
# ALCHEMY WEBHOOKS
# ============================================================================
ALCHEMY_WEBHOOK_SECRET="your-webhook-secret-from-alchemy-dashboard"

# ============================================================================
# COLD STORAGE WALLETS (Where funds are swept)
# ============================================================================
COLD_WALLET_ETH="0x..."  # Your cold wallet address for ETH
COLD_WALLET_BSC="0x..."  # Your cold wallet address for BSC
COLD_WALLET_POLYGON="0x..."  # Your cold wallet address for Polygon

# ============================================================================
# SWEEP THRESHOLDS (Optional - has defaults)
# ============================================================================
SWEEP_THRESHOLD_ETH=0.01
SWEEP_THRESHOLD_BNB=0.01
SWEEP_THRESHOLD_MATIC=0.1
```

## ๐ฏ ุชุณูุณู ุงูุนูููุงุช (End-to-End)

### Happy Path Flow:

```
1. ุงููุณุชุฎุฏู โ ูุฏุฎู $10 ููุฎุชุงุฑ USDT (BSC)
                 โ
2. Backend โ CoinLore API โ ุงูุณุนุฑ: $1
                 โ
3. Backend โ ูุญุณุจ ุงููุจูุบ: $10 ร 1.01 = 10.1 USDT
                 โ
4. Backend โ HD Wallet โ ูููุฏ ุนููุงู: 0xabc...
                 โ
5. Frontend โ ูุนุฑุถ:
   - ุงููุจูุบ: 10.1 USDT
   - QR Code
   - ุงูุนููุงู
   - ุงููุคูุช: 15:00
                 โ
6. ุงููุณุชุฎุฏู โ ูุฑุณู 10.1 USDT ุฅูู 0xabc...
                 โ
7. Alchemy โ Webhook โ Backend
                 โ
8. Backend โ ุงูุชุญูู ูู ุงููุนุงููุฉ ุนูู blockchain
                 โ
9. Backend โ ุญุงูุฉ: CONFIRMING โ ููุชุธุฑ 10 ุชุฃููุฏุงุช
                 โ
10. Backend โ ุญุงูุฉ: COMPLETED โ ูุถูู $10 ุฅูู ูุญูุธุฉ ุงููุณุชุฎุฏู
                 โ
11. Backend โ Auto-Sweep โ ูุญูู ุงูู 10.1 USDT ุฅูู Cold Storage
                 โ
12. Frontend โ ูุนุฑุถ: "ุชู ุงุณุชูุงู ุงูุฅูุฏุงุน ุจูุฌุงุญ! โ"
```

## ๐ ุงูุฎุทูุงุช ุงูุชุงููุฉ

### ูุจุฏุก ุงูุงุณุชุฎุฏุงู:

1. **ุฅุนุฏุงุฏ Alchemy:**
   - ุณุฌู ูู https://www.alchemy.com/
   - ุฃูุดุฆ ุชุทุจููุงุช ูู BSC ู Polygon
   - ุฃุถู Webhook ููู Address Activity
   - ุงูุณุฎ `ALCHEMY_API_KEY` ู `ALCHEMY_WEBHOOK_SECRET`

2. **ุชูููุฏ HD Wallet (ูู Cold Storage):**
   ```bash
   # ุชูููุฏ mnemonic ุฌุฏูุฏ (ูุฑุฉ ูุงุญุฏุฉ ููุท!)
   npx mnemonic-gen

   # ุฃู ุงุณุชุฎุฏู:
   # https://iancoleman.io/bip39/ (ูู ูุถุน offline)
   ```

3. **ุชูููุฏ ููุชุงุญ ุงูุชุดููุฑ:**
   ```bash
   openssl rand -hex 32
   ```

4. **ุฅุนุฏุงุฏ Cold Wallet:**
   - ุงุณุชุฎุฏู Hardware Wallet (Ledger, Trezor)
   - ุฃู ุฃูุดุฆ wallet ูู cold storage (offline)
   - ุงูุณุฎ ุงูุนูุงููู ุฅูู `COLD_WALLET_*`

5. **ุงุฎุชุจุงุฑ ุงููุธุงู:**
   - ุงุจุฏุฃ ุจุดุจูุฉ BSC Testnet
   - ุฃุฑุณู ูุจูุบ ุตุบูุฑ ููุชุฃูุฏ ูู ุงูุชุณูุณู ุงููุงูู
   - ุชุญูู ูู:
     - โ ุงุณุชูุงู Webhook
     - โ ุชุญุฏูุซ ุงูุญุงูุฉ
     - โ ุฅุถุงูุฉ ุงูุฑุตูุฏ ูููุณุชุฎุฏู
     - โ ุงูุชุญููู ุฅูู Cold Storage

## ๐ ููุงุฑูุฉ ุจุงูุฎุทุฉ ุงูุฃุตููุฉ

| ุงููุชุทูุจ | ุงูุฎุทุฉ | ุงููุถุน ุงูุญุงูู |
|---------|-------|--------------|
| BSC Priority | โ | โ ููููููุฐ |
| Polygon Priority | โ | โ ููููููุฐ |
| Alchemy RPC | โ | โ ููููููุฐ |
| Alchemy Webhooks | โ | โ ููููููุฐ |
| CoinLore Prices | โ | โ ููููููุฐ (ุฌุฏูุฏ) |
| HD Wallet (BIP44) | โ | โ ููููููุฐ |
| AES-256 Encryption | โ | โ ููููููุฐ |
| Auto-Sweeping | โ | โ ููููููุฐ |
| Price Lock (15 min) | โ | โ ููููููุฐ |
| Safety Margin | โ | โ ููููููุฐ (1%) |
| Frontend Real-time Status | โ | โ ููููููุฐ (Polling 5s) |
| TxHash Uniqueness | โ | โ ููููููุฐ |

## โ ุงูุฎูุงุตุฉ

**ุงููุธุงู ููููู 100%** ููุนูู ุชูุงูุงู ููุง ูู ูุทููุจ ูู ุฎุทุชู!

ุฌููุน ุงูููููุงุช ุงูุฃุฑุจุนุฉ ุงูุฑุฆูุณูุฉ ููููููุฐุฉ:
1. โ Low-Fee Networks (BSC, Polygon)
2. โ Alchemy Integration (RPC + Webhooks)
3. โ CoinLore Price Conversion
4. โ HD Wallet + Encryption + Auto-Sweeping

ุงููุธุงู ุฌุงูุฒ ููุงุณุชุฎุฏุงู ูู Production ุจุนุฏ:
1. ุฅุถุงูุฉ ูุชุบูุฑุงุช ุงูุจูุฆุฉ
2. ุฅุนุฏุงุฏ Alchemy Webhook URL
3. ุชูููุฏ mnemonic ุญูููู (ูููุณ test)
